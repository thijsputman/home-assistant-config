- alias: 🚨 Trigger alarm (door / window opened)
  description: ''
  trigger:
  - platform: state
    # Not using groups of sensors – They will trigger "off" → "on" if one of
    # their members transitions from "unavailable" → "on", which leads to false
    # alarms...
    # Furthermore, listing the individual entities is relevant as some
    # doors/windows might intentionally be left open – using a group would
    # obscure all further state transitions.
    entity_id:
    - binary_sensor.openclose_12
    - binary_sensor.openclose_16
    - binary_sensor.openclose_17
    - binary_sensor.openclose_33
    - binary_sensor.openclose_36
    - binary_sensor.openclose_18
    - binary_sensor.openclose_19
    - binary_sensor.openclose_20
    - binary_sensor.openclose_8
    - binary_sensor.openclose_14
    - binary_sensor.openclose_15
    from: 'off'
    to: 'on'
  condition:
  - condition: or
    conditions:
    - condition: state
      entity_id: alarm_control_panel.home_alarm
      state: armed_away
    - condition: state
      entity_id: alarm_control_panel.home_alarm
      state: armed_night
  action:
  - service: alarm_control_panel.alarm_trigger
    data: {}
    entity_id: alarm_control_panel.home_alarm
  mode: single
- alias: 🚨 | 🔊 Sound the alarm (alarm triggered)
  description: ''
  trigger:
  - platform: state
    entity_id: alarm_control_panel.home_alarm
    to: triggered
  condition: []
  action:
  - service: switch.turn_on
    entity_id: switch.warning_device_8
  mode: single
- alias: 🚨 | 🔊 Stop sounding the alarm (alarm trigger ended)
  description: ''
  trigger:
  - platform: state
    entity_id: alarm_control_panel.home_alarm
    from: triggered
  condition: []
  action:
  - service: switch.turn_off
    entity_id: switch.warning_device_8
  mode: single
- alias: 🚨 | 🕹️ Mute/unmute the alarm (Bedroom Smart Switches)
  description: ''
  trigger:
  # Bedside Smart Switches
  - device_id: da1237666189a9a364fa383795ba532d
    domain: deconz
    platform: device
    type: remote_button_short_press
    subtype: turn_on
  - device_id: b26003b4b78afd0e5b2c3bcb3b06eeeb
    domain: deconz
    platform: device
    type: remote_button_short_press
    subtype: turn_on
  condition:
  # Only act if the "Home Alarm" is triggered _and_ someone is home
  - condition: state
    entity_id: alarm_control_panel.home_alarm
    state: triggered
  - condition: state
    entity_id: group.family
    state: home
  action:
  - choose:
    - conditions:
      - condition: state
        entity_id: switch.warning_device_8
        state: 'on'
      sequence:
      - service: switch.turn_off
        entity_id: switch.warning_device_8
    - conditions:
      - condition: state
        entity_id: switch.warning_device_8
        state: 'off'
      sequence:
      - service: switch.turn_on
        entity_id: switch.warning_device_8
    default: []
  mode: single
- alias: 🚨 | 💡 Bedroom lights on (everyone asleep; alarm triggered)
  description: ''
  trigger:
  - platform: state
    entity_id: alarm_control_panel.home_alarm
    to: triggered
  condition:
  - condition: state
    entity_id: input_boolean.everyone_asleep
    state: 'on'
  action:
  - service: light.turn_on
    data:
      brightness: 255
      kelvin: 6500
    entity_id: light.bedroom
  mode: single
- alias: 🚨 | 💡 Flash lights (pending alarm; front or back door open)
  description: ''
  trigger:
  - platform: state
    entity_id: alarm_control_panel.home_alarm
    to: pending
  condition: []
  action:
  - choose:
    - conditions:
      # Front door
      - condition: state
        entity_id: binary_sensor.openclose_16
        state: "on"
      sequence:
      - service: light.turn_on
        data:
          flash: long
          entity_id:
          - light.hue_filament_bulb_1_5
          - light.hue_filament_bulb_1_4
    - conditions:
      # Back door
      - condition: state
        entity_id: binary_sensor.openclose_12
        state: "on"
      sequence:
      - service: light.turn_on
        data:
          flash: long
          entity_id:
          - light.spot_4_kitchen_garden_side
          - light.spot_3_kitchen
    default: []
  mode: single
- alias: 🚨 | 📱 Send notification (alarm pending)
  description: ''
  trigger:
  - platform: state
    entity_id: alarm_control_panel.home_alarm
    to: pending
  condition: []
  action:
  - service: script.persistent_notification_all_devices
    data:
      tag: home_alarm
      title: Home Alarm pending!
      message: >-
        The Home Alarm just got activated!
        If not promptly disarmed it will trigger...
  mode: single
- alias: 🚨 | 📱 Send notification (alarm triggered)
  description: ''
  trigger:
  - platform: state
    entity_id: alarm_control_panel.home_alarm
    to: triggered
  condition: []
  action:
  - service: script.persistent_notification_all_devices
    data:
      # Separate tag – dismissing this from the Lovelace UI will *not*
      # auto-dismiss it from any of the other devices
      tag: home_alarm_triggered
      title: Home Alarm triggered!
      message: >-
        The Home Alarm just got triggered!
  mode: single
# Toggle "input_boolean.active_alarm_state" to "true" when the alarm goes to
# "pending" and keep it that way until the alarm is actively disarmed. Indicates
# the home is an active alarm state – mainly used to hide semi-sensitive
# information from a tech-savvy burglar trying to use the Lovelace dashboard.
- alias: 🚧 | 🚨 Active alarm state
  description: ''
  trigger:
  - platform: state
    entity_id: alarm_control_panel.home_alarm
    to: pending
  - platform: state
    entity_id: alarm_control_panel.home_alarm
    to: disarmed
  condition: []
  action:
  - choose:
    - conditions:
      - condition: state
        entity_id: alarm_control_panel.home_alarm
        state: pending
      sequence:
      - service: input_boolean.turn_on
        data:
          entity_id: input_boolean.active_alarm_state
    - conditions:
      - condition: state
        entity_id: alarm_control_panel.home_alarm
        state: disarmed
      sequence:
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.active_alarm_state
    default: []
  mode: single
