# Restore twice daily from potential overrides that happen further down in this
# file
- alias: Airco (Bedroom) restore schedule
  id: bdfe854c-79d1-474d-a30e-84a3e99e1672
  triggers:
    - trigger: time
      at: "01:00:00"
    - trigger: time
      at: "11:00:00"
  conditions:
    - condition: state
      entity_id: input_boolean.airco_active
      state: "on"
    - condition: state
      entity_id: climate.tado_bedroom_ac
      attribute: preset_mode
      state: home
    - condition: not
      conditions:
        - condition: state
          entity_id: climate.tado_bedroom_ac
          state: auto
  actions:
    - action: climate.set_hvac_mode
      data:
        hvac_mode: auto
      target:
        entity_id: climate.tado_bedroom_ac
  mode: single
# tado° Is scheduled to switch on daily at 22:30 – the below is in case someone
# goes to bed early
- alias: Airco (Bedroom) nighttime early on
  id: d32f9d2b-c66c-41d2-85dd-b3049a077dce
  triggers:
    - trigger: state
      entity_id: binary_sensor.occupancy_bed
      from: "off"
      to: "on"
      for: "00:05:00"
    - trigger: state
      entity_id: script.lights_out
      from: "off"
      to: "on"
  conditions:
    - condition: state
      entity_id: input_boolean.airco_active
      state: "on"
    - condition: state
      entity_id: climate.tado_bedroom_ac
      attribute: preset_mode
      state: home
    - condition: state
      entity_id: climate.tado_smart_ac_control_bedroom
      state: "off"
    # Don't trigger after going to bed, nor in the morning after waking up...
    - condition: state
      entity_id: input_boolean.everyone_asleep
      state: "off"
    - condition: state
      entity_id: timer.wakeup_grace_time
      state: idle
  actions:
    # Control properly via the tado°-integration – the settings below are
    # identical to what is scheduled to happen at 22:30
    - action: script.climate_set_operating_mode
      data:
        entity_id: climate.tado_bedroom_ac
        hvac_mode: cool
        swing_mode: "off"
        fan_mode: low
        temperature: 20
  mode: single
# tado° Is scheduled to switch off daily at 09:00/10:00 (weekdays versus
# weekend) – the below is in case we get out of bed early
- alias: Airco (Bedroom) off
  id: 6767ad63-9f59-4d70-b304-45cafd75442e
  triggers:
    - trigger: state
      entity_id: light.bedroom
      from: "on"
      to: "off"
      for: "00:05:00"
  conditions:
    - condition: state
      entity_id: input_boolean.airco_active
      state: "on"
    - condition: state
      entity_id: climate.tado_smart_ac_control_bedroom
      state: cool
    # Only act when the wakeup "grace-time" timer is running — this ensures it's
    # in the morning _after_ the wakeup-alarm has sounded
    - condition: state
      entity_id: timer.wakeup_grace_time
      state: active
  actions:
    - action: climate.set_hvac_mode
      data:
        hvac_mode: "off"
      target:
        entity_id: climate.tado_bedroom_ac
  mode: single
# Prevent the Bedroom- and Attic-aircos from running simultaneously – doesn't
# blow a fuse, but leaves too little margin for comfort. There's an opposite
# automation defined in "attic.yaml".
- alias: Airco (Bedroom) off
  id: 620de186-54bc-4c1c-a3df-761186db44c9
  triggers:
    - trigger: state
      entity_id: climate.tado_smart_ac_control_bedroom
      from: "off"
      to: cool
  conditions:
    - condition: state
      entity_id: climate.tado_smart_ac_control_attic
      state: cool
  actions:
    # Pull the handbrake (HomeKit is most responsive)
    - action: climate.set_hvac_mode
      data:
        hvac_mode: "off"
      target:
        entity_id: climate.tado_smart_ac_control_bedroom
    - action: script.turn_on
      target:
        entity_id: script.tts_announce
      data:
        variables:
          rooms: bedroom
          priority: attention
          message: >-
            The airco in the Attic is switched on; please switch it off before
            switching on the airco in the Bedroom...
  mode: single
- alias: Airco (Bedroom) nighttime airflow adjustment
  id: ac143f4e-ef0a-4da5-a975-9793c81a4373
  triggers:
    - trigger: state
      entity_id: climate.tado_smart_ac_control_bedroom
      from: "off"
      to: cool
    - trigger: state
      entity_id: input_boolean.everyone_asleep
      from: "off"
      to: "on"
    - trigger: state
      entity_id: script.lights_out
      from: "off"
      to: "on"
    # Temperature-based triggers
    - trigger: numeric_state
      entity_id: sensor.smart_ac_control_wr2352422400_current_temperature
      above: 26
      for: "00:05:00"
    - trigger: numeric_state
      entity_id: sensor.smart_ac_control_wr2352422400_current_temperature
      above: 24
      below: 26
      for: "00:05:00"
    - trigger: numeric_state
      entity_id: sensor.smart_ac_control_wr2352422400_current_temperature
      above: 20.5
      below: 24
      for: "00:05:00"
    - trigger: numeric_state
      entity_id: sensor.smart_ac_control_wr2352422400_current_temperature
      below: 20.5
      for: "00:05:00"
    # Fallback in case tado° messes with the fan-speed
    - trigger: state
      entity_id: climate.tado_bedroom_ac
      attribute: fan_modes
  conditions:
    - condition: state
      entity_id: input_boolean.airco_active
      state: "on"
    - condition: state
      entity_id: climate.tado_bedroom_ac
      attribute: preset_mode
      state: home
    - condition: state
      entity_id: climate.tado_smart_ac_control_bedroom
      state: cool
    - condition: or
      conditions:
        - condition: state
          entity_id: binary_sensor.occupancy_bed
          state: "on"
        - condition: state
          entity_id: input_boolean.everyone_asleep
          state: "on"
        - condition: state
          entity_id: script.lights_out
          state: "on"
  actions:
    # Switching the airco off via tado° is not a use-case: The airco manages
    # itself just fine (and I don't mind it running silently in the background).
    # As the airco is higher up in the room than the tado°-unit, it'll barely
    # bring the temperature to the setpoint (20° C) from tado°'s perspective...
    - choose:
        # Fan-speed 4
        - conditions:
            # The HomeKit-backed temperature-sensor of the tado° unit itself is
            # most appropriate in this case
            - condition: numeric_state
              entity_id: >-
                sensor.smart_ac_control_wr2352422400_current_temperature
              above: 26
          sequence:
            - action: fan.set_percentage
              data:
                percentage: 100
              target:
                entity_id: fan.airco_bedroom_broadlink
        # Fan-speed 3
        - conditions:
            - condition: numeric_state
              entity_id: >-
                sensor.smart_ac_control_wr2352422400_current_temperature
              above: 24
          sequence:
            - action: fan.set_percentage
              data:
                percentage: 75
              target:
                entity_id: fan.airco_bedroom_broadlink
        # Fan-speed 2
        - conditions:
            - condition: numeric_state
              entity_id: >-
                sensor.smart_ac_control_wr2352422400_current_temperature
              above: 20.5
          sequence:
            - action: fan.set_percentage
              data:
                percentage: 50
              target:
                entity_id: fan.airco_bedroom_broadlink
      # Fan-speed 1
      default:
        - action: fan.set_percentage
          data:
            percentage: 25
          target:
            entity_id: fan.airco_bedroom_broadlink
    # As there's a broad array of triggers, block for one-minute to prevent
    # unintentionally triggering in rapid succession
    - delay: "00:01:00"
  mode: single
  max_exceeded: silent
