- alias: ðŸ›’ | ðŸ’¤ Prepone Â«wakeupÂ» time (Albert Heijn arriving early)
  id: 866031ac-89c6-4ab4-8a76-b0f67b910ae7
  trigger:
    - platform: state
      entity_id: sensor.last_notification_albert_heijn_eta
      to: ~
  condition:
    - condition: state
      entity_id: group.family
      state: home
    - condition: time
      before: input_datetime.wakeup
    - condition: not
      conditions:
        - condition: state
          entity_id: sensor.last_notification_albert_heijn_eta
          state: unavailable
    # Ensure Albert Heijn ETA is for *today* â€” the subsequent time comparison
    # assumes it is (so crazy stuff happens if we don't explicitly check for it
    # here)
    - condition: template
      value_template: >-
        {{
          (states('sensor.last_notification_albert_heijn_eta') |
            as_datetime | as_timestamp | timestamp_custom('%Y-%m-%d')
          ) == (now() | as_timestamp | timestamp_custom('%Y-%m-%d'))
        }}
    # Albert Heijn ETA is at most 15-minutes _after_ Â«wakeupÂ» time (our
    # "wakeup grace-period")
    - condition: template
      value_template: >-
        {{
          states('sensor.last_notification_albert_heijn_eta') | as_datetime
            - timedelta(minutes=15) <= today_at(states('input_datetime.wakeup'))
        }}
  action:
    # Set Â«wakeupÂ» time to 15-minutes _before_ Albert Heijn ETA â€” note that
    # "input_datetime.wakeup" only cares about the time component; the date
    # component is ignored
    - service: input_datetime.set_datetime
      data:
        datetime: >-
          {%
            set wakeup = states('sensor.last_notification_albert_heijn_eta') |
              as_datetime - timedelta(minutes=15)
          %}
          {#
            If the Â«wakeupÂ» time would be _before_ the current time, set the
            alarm to sound ASAP. This is possible if an ETA change comes through
            very late (i.e., within the "wakeup grace-period").
          #}
          {% if wakeup <= now() %}
            {{ now() + timedelta(seconds=10) }}
          {% else %}
            {{ wakeup }}
          {% endif %}
      target:
        entity_id: input_datetime.wakeup
  mode: single
- alias: ðŸ›’ | ðŸ”Š Announce Albert Heijn ETA (wakeup alarm snoozed or silenced)
  id: 381fa915-60ea-4d01-ab6c-51d245da3b8d
  trigger:
    - platform: event
      event_type: timer.started
      event_data:
        entity_id: timer.wakeup_snooze_time
    - platform: event
      event_type: wakeup_alarm_silenced
  condition:
    - condition: not
      conditions:
        - condition: state
          entity_id: sensor.last_notification_albert_heijn_eta
          state: unavailable
    # Albert Heijn ETA is for today
    - condition: template
      value_template: >-
        {{
          states('sensor.last_notification_albert_heijn_eta') | as_datetime
            >= today_at('00:00:00')
        }}
  action:
    - delay: 5
    - variables:
        eta_start: >-
          {%-
            set start = states('sensor.last_notification_albert_heijn_eta') |
              as_datetime
          -%}
          {{ start.hour }}:{{ start.minute }}
        eta_end: >-
          {%-
            set end = states('sensor.last_notification_albert_heijn_eta') |
              as_datetime + timedelta(seconds=state_attr(
                  'sensor.last_notification_albert_heijn_eta', 'interval'))
          -%}
          {{ end.hour }}:{{ end.minute }}
        eta_minutes: >-
          {{
            ((states('sensor.last_notification_albert_heijn_eta') |
              as_timestamp - now() | as_timestamp) / 60) | int
          }}
    - service: media_player.volume_set
      data:
        entity_id: media_player.pi0_speaker_bedroom
        volume_level: 0.45
    - service: tts.cloud_say
      data:
        entity_id: media_player.pi0_speaker_bedroom
        # cspell: disable
        # Cloud TTS chokes on "Heijn"...
        message: >-
          Good morning, Albert Heyn expects to arrive between {{ eta_start }}
          and {{ eta_end }}. That is in {% if eta_minutes < 60 -%}
            {{ eta_minutes }} minutes...
          {% else -%}
            more than an hour...
          {% endif %}
        # cspell: enable
        language: en-GB
  mode: single
