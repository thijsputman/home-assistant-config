<!-- vim: syntax=Markdown -->

# ToDo

- [General](#general)
  - [Bugs](#bugs)
  - [Features](#features)
  - [Development Environment](#development-environment)
- [Lovelace](#lovelace)
- [Notifications](#notifications)
  - [Mobile](#mobile)
  - [TTS](#tts)
  - [SMS](#sms)
- [Climate](#climate)
- [Lights](#lights)
- [Alarm](#alarm)
  - [Bugs](#bugs-1)
  - [Features](#features-1)
- [Arlo](#arlo)
- [Network](#network)
- [Hardware](#hardware)

## General

### Bugs

- [ ] ‚ùóNot all data appears to be ending up in InfluxDB (e.g., the Arlo battery
      levels are missing?)
- [ ] The `sensor.consumption_ups` (Riemann sum integral) deviates a lot from
      its expected daily total (sometimes reporting less than 30% of what it
      should be) every couple of days
  - Appears to be the result of the UPS power consumption not fluctuating
    enough. It stays at the same level for long periods; if that happens at the
    end of the day, the final hours of the day aren't counted...
- [ ] The Mi Flora sensors (connected via `bt2mqtt`) stop reporting data when
      they fail, but under normal operation they might also not report updated
      data for quite some time... Add an automation that "invalidates" these
      devices after none of their sensors updates over a 24-hour window? This
      way a failure will (eventually) show up through the generic "device
      failure"-automation
- [ ] Remove `monthly_consumption_lights_all` from `üìÑ utility_meter.yaml`
      _after_ February 1, 2022 (and don't forget to update Lovelace)
- [ ] If `ERROR: No deconz_event tied to device "..." found` shows up at Home
      Assistant startup, wait a couple minutes and reload the automations. This
      ensures all deCONZ device-trigger will work as intended (it happens when
      the automations are initialised before the deCONZ integration is fully up
      and running).

### Features

- [ ] Move all icon customisations for sensors defined in YAML from
      `üìÑ customize.yaml` to their respective YAML files; for all other sensors,
      aim to customise their icons through the UI (add `unique_id` where
      necessary)
  - As of HA 2021.12 it appears `üìÑ customize.yaml` is slowly getting phased out
- [ ] Clean-up inconsistent entity IDs
  - Especially those coming from deCONZ (half of them are `light_x`,
    `openclose_y`, the other half already have descriptive names)
  - Some other things are also inconsistent (e.g. `power_xxx` versus `xxx_power`
    and `consumption_xxx` versus `xxx_consumption`)
  - Part of the inconsistency is caused by the fact that (new format) template
    sensors don't allow specifying a `friendly_name` anymore, so the `entity_id`
    is derived from the `name` and a balance needs to be struck between
    human-readable and structured (otherwise all friendly names should be
    (re)defined via the UI)
  - In general, decide how to proceed: Should all entities have descriptive
    names or is it acceptable to just have them all called `entity_type_001`?
    Either approach will lead to inconsistencies over time I'm afraid... Giving
    a new devices and old device's entity ID is easy, so from that perspective
    it really doesn't matter.
- [ ] State attributes store history too, so there's no need to create template
      sensors if they're purely used for graphing in dashboards
      (`mini-graph-card` can graph attributes) or in other automations (use a
      template to retrieve the attribute's value if everything else fails)
  - Main value of template sensors is to easily retrieve an attribute's history
    without having it structural on a dashboard (i.e. incidental usage)
  - See which of the current template sensors (mainly tado¬∞ related) are
    actually useful given the above considerations; remove the ones that are
    not...
- [ ] Clean up `üìÑ sensors.yaml` (i.e., move its contents into the `üìÅ sensors`
      folder). Do the same with the binary sensors (move them from
      `üìÑ configuration.yaml` into `üìÅ sensors_binary`).
  - Reimplement all template sensors using
    [the new format](https://www.home-assistant.io/integrations/template) and
    move them into the `üìÅ templates` folder
  - There's a handful of template sensors (`sensor.binary_...`) that should've
    been implemented as template binary sensors ‚Äì correct those
  - Use
    [**trigger-based template sensors**](https://www.home-assistant.io/integrations/template/#configuration-for-trigger-based-template-sensors)
    where appropriate. For example, several sensors in
    [`üìÑ sensors/dsmr.yaml`](./sensors/dsmr.yaml) use `now()` in a static manner
    (i.e. to do date arithmetic) ‚Äì making these trigger-based stops them from
    rendering unnecessarily once-per-minute (due to the inclusion of `now()` in
    their templates)
- [ ] Use generic names for the mobile devices registered through the "Mobile
      App" integration (`pixel_6_pro`, `sm_g930f` and `p20hd_eea`). Knowing the
      model numbers of these devices allows one to deduce the vendor prefixes of
      their WiFi and Bluetooth MAC addresses, which in turn _could_ be used to
      pinpoint the exact location of the house (if the combination of the three
      device types is unique enough ‚Äì which it might).
- [ ] Experiment with using the amount of rain and the (WeeWX calculated)
      evapotranspiration to indicate whether the garden should be watered
  - For now just graphing the daily delta between the two to get a bit of a
    feeling on how the data moves
  - ~~Added `sensor.weewx_rain_day` (the daily rain tally kept by WeeWX itself)
    to compare against (i.e. validate the accuracy of) the integral
    calculation~~ The computed integral appears acceptably close to the value
    reported by WeeWX itself
- [ ] It could be nice to also track water consumption. See for example
      <https://www.ztatz.nl/p1-monitor-watermeter/>
  - Apart from tracking consumption, it could also serve as an (early) warning
    in case of water leaks
- [ ] Use the power consumption sensor for the "multimedia hub" in the Living
      room to detect if the projector is on (in which case certain lighting
      automation should be disabled) ‚Äì as an addition to the Android TV based
      automations (which work wonderfully, but only when the Shield TV is active
      and not, for example, when the Nintendo Switch is being used)
- [ ] Enable the `retain`-attribute for all MQTT-topics (either by updating the
      publishing logic, or by manually toggling the attribute on the MQTT server
      itself?)
- [ ] Add tilt sensors to all "tilting" windows (both horizontal and vertical)
  - Use these (in addition to the `openclose` sensors) to detect a potential
    break-in (i.e. windows can be left ajar and still trigger the alarm)
  - Use these (_instead of_ the `openclose` sensors) to warn when windows are
    open and it starts to rain (i.e. don't warn if a window ajar; it's probably
    left open intentionally)
  - Perhaps provide a warning when the Attic window is fully closed (in
    principle it's ventilation hatch should always be open) ‚Äì same for the
    Bedroom, when we go to bed at least one of the windows should be ajar...
    This could be via TTS when all lights are switched off before going to bed
- [ ] Rename `neato_d7` to `d7_downstairs` to match the new upstairs unit
- [ ] Rename `sensor.xiaomi_miot_environment_co2_density` to match with the
      other Qingping senors
- [ ] See if it's possible everywhere to replace the custom `template_reloaded`
      event with `from: unknown` state-triggers

### Development Environment

- [ ] Validate all Home Assistant YAML-files against their (JSON) schemas prior
      to committing (and as part of the linter GitHub Action)

## Lovelace

- [ ] SMS functionality: Show cellular reception and credit remaining
- [ ] Provide a visual indication of the Remote UI (Nabu Casa) status.
      Connection issues there otherwise might go unnoticed for some time (while
      they do mess with the Mobile App functionalities)
- [ ] Add an overview of motion/vibration sensors
  - Perhaps create separate Security-dashboard?
- [ ] Add visual indication of "Vacation-mode"
- [ ] Add buttons to toggle the entire house to a specific Hue scene ("Alarm",
      "Active" and "Ambiance")
- [ ] Create an "Air Quality" dashboard. Move ventilation- and CO‚ÇÇ-related stuff
      from the "Climate" dashboard; add additional air-quality metrics (e.g.,
      Attic exhaust fan, Bedroom window)

## Notifications

### Mobile

- [ ] Change click-action based on notification context
- [ ] Allow notifications to be dismissed even if `lovelaceDismiss` is _not_
      enabled; this is currently impossible. See
      `üìÑ automations/alarm/away.yaml` for an example where this causes a
      (highly theoretical üòâ) vulnerability
- [ ] It appears that dismissing (i.e. "swiping away") notifications on Android
      raises an event on the Home Assistant side ‚Äì useful to act on this?
- [ ] Change
      [the status bar icon](https://companion.home-assistant.io/docs/notifications/notifications-basic/#notification-status-bar-icon)
      for certain notifications
- [ ] Implement
      "[alert once](https://companion.home-assistant.io/docs/notifications/notifications-basic/#alert-once)"
      for certain notifications?
- [ ] Send a notification when the washing machine/dryer is done
- [ ] Send notifications (with snapshot/thumbnail) if Arlo records something
      when "Armed away"
  - Replaces the "native" Arlo notifications

### TTS

- [ ] Use VLC (instead of native Android notifications) for TTS on the tablet in
      the Kitchen ‚Äì has a much more natural voice
- [ ] Extend TTS to the speaker in the Bedroom?

### SMS

- [ ] Control lighting (status; switch rooms on and off)
- [ ] Control heating/airco (status; switch heating/airco on and off)

## Climate

- [ ] Create several "backstops" (controlled via HomeKit) to ensure heating is
      properly controlled when there is no access to the online Tado service
  - ~~On hold till the first time this actually turns out to be an issue. As of
    yet, the Tado online service has been rock-solid...~~
  - It appears Tado's schedule is enforced _remotely_ (i.e. if there's no active
    Internet connection, the scheduled settings are _not_ applied). Thus, sadly,
    the schedule should be enforced/backstopped locally via HomeKit...
- [ ] See if it's possible to better combine Attic thermostat/heating and airco
      automations ‚Äì there's currently a lot of (semi-)identical stuff there (and
      some slightly different approaches aiming to achieve the same thing)...
- [ ] Reset the Attic radiator back to "scheduled mode" every night (similar to
      what happens with the Airco) to ensure it keeps following the schedule
      regardless of what happened the day before
- [ ] Just like the heating in the Attic, the airco unit most likely also needs
      to be switched off manually when Tado transitions from Away- to Home-mode
      (otherwise it reverts back to its schedule and switches on even though
      no-one is present in the Attic)
- [ ] Implement proper controls for the Airco in the Bedroom (most probably
      delayed till next Summer, there wasn't any need for it this year üå¶Ô∏èüò¢)
  - Use Broadlink IR-blaster to control fan direction and some other advanced
    options not available in tado¬∞ (in response to tado¬∞ actions)
- [ ] Switch on Sonair ventilator in Living Room when CO‚ÇÇ level gets too high
      (speed 8 at 900 PPM; speed 10 at 1100 PPM)
- [ ] Switch on the Attic (exhaust) ventilator when the CO‚ÇÇ gets above 1,000 PPM
      in the Attic (and the Attic is occupied). Probably good to also switch it
      on during the night regardless...
- [ ] Define template binary sensors for "Living room thermostat on" and "Attic
      radiator on". This is currently hard-coded in multiple automations based
      on temperature setpoints (> 16¬∫C and 18¬∫C respectively). Better to
      abstract this away.

## Lights

- [ ] Replace all calls to the `hue.hue_activate_scene` script with native Home
      Assistant scene changes; see
      <https://github.com/home-assistant/core/pull/58996>
  - ~~It appears I'll need to recreate all (relevant) scenes in the Hue app as
    none of the current Hue scenes have shown up in the UI with the migration to
    HA 2021.12...~~ The Hue integration switched over to the V2 API after the
    _second_ restart of Home Assistant ‚Äì right when I wasn't expecting it üòï
  - Wait with further migration actions until
    [this issue](https://github.com/home-assistant/core/issues/61554) gets
    sorted out; most likely as of Home Assistant 2022.2
  - The groundwork has already been laid for an easy migration: All relevant Hue
    scene heuristic template sensors have an attribute that represents their
    active scene as a Home Assistant native scene (`scene.room_scene_name` or
    `<None>` if not available) ‚Äì a simple helper script (to be written) should
    enable hassle free switching of scenes...
  - Once all changes are implemented (and stabilised), see if all of the
    "band-aid (ü©π)" Hue automations are still required
- [ ] For Summer: Garden light automatic off should only happen if light state
      has not been modified manually (i.e. we're sitting outside)
- [ ] Failure mode for Kitchen-counter motion lights: Switch Kitchen to
      "Ambiance", trigger counter motion sensor, switch Kitchen to "Bright
      (Custom)" (while motion sensor is still active). After motion clears,
      Kitchen switches back to "Ambiance" instead of to "Bright (Custom)"
- [ ] Use "Light Group" instead of regular groups for grouping lights (where
      applicable ‚Äì only makes sense when the group of lights needs (advanced)
      light control, not necessary for basic operations (i.e. on/off).
- [ ] Failure mode for Bathroom motion-sensing automation: If the light-level
      falls below its threshold while a motion sensors remains triggered, the
      light will never come on (as the automation doesn't restart until the
      motion sensor clears and retriggers). Instead of using a (preemptive)
      condition, use a waiting-loop that continuously (i.e. every 30 seconds)
      evaluates the conditions
- [ ] Failure mode for Living room Hue scene heuristic: When the brightness of
      the Ensuite ceiling lamp is increased during the "Daytime" scene, the
      detected scene does not change (most likely the overall change is too
      small ‚Äì might require a specific exception)
- [ ] Daytime lights in the downstairs Hallway are switched on a bit too much...
- [ ] Have the buttons next to the bed control the Bedroom lights
  - ‚úîÔ∏è Toggle off when on; on when off
  - Cycle through various other modes (with long press?)
- [ ] Containerize the Fireplace Node.js code; create some helpers scripts in
      Home Assistant to facilitate the switching on/off (mainly so that their
      previous state gets automatically restored)
- [ ] Create a toggle in Lovelace stop the television from overriding the
      lighting settings (for when not everyone is watching television) ‚Äì there's
      a lot of "magic" automation potential here, but the best solution is most
      likely to manual turn off the behaviour when it's unwanted... üòá
- [ ] Create a Living Room "raw" Hue scene heuristic and combine this with the
      state of the Ensuite lamp in a derived scene to create a situation
      (similar to the Kitchen) where the Ensuite lamp can be maintained separate
      of the overall Living Room scene
  - This should make it possible to retain the state of the Ensuite lamp while
    changing the Living Room scene as a whole
  - This should also help resolving the (occasional) situation where the Ensuite
    lamp doesn't properly react to Hue commands (mainly when initially turning
    on) ‚Äì can be detected and automatically resolved

## Alarm

### Bugs

üéâ

### Features

- [ ] Create proxy template binary sensor for the "Everyone away"-state (instead
      of using `group.family` directly; "Guest"-mode stops `group.family` from
      automatically setting "Everyone away"). Setting the alarm to "Arm away"
      should enable "Everyone away". This sensor can then be used to control the
      alarm _and_ all other things that should (not) happen when no-one is
      home....
  - The template sensor should trigger when devices leave the home WiFi. If
    triggered this way, also check GPS state (which _initially_ is leading). An
    identical, but delayed, trigger re-evaluates this decision; _ignoring_ the
    GPS state. GPS is convenient, but error-prone (updates slowly/not at all due
    to Android (battery) issues; requires remote-UI connection ‚Äì which is 99%,
    but not 100% stable). To prevent short WiFi drops from wreaking havoc, we
    rely on GPS. After a while it becomes better to assume to GPS has bugged out
    and trust the WiFi. This solution isn't without its false positives either,
    but they will be less problematic than _not_ triggering "Everyone away" at
    all...
  - Some more elaborate notifications might be in place to provide hints as to
    _why_ "Everyone away" was enabled/disabled.
- [ ] Add a "Guest-mode" toggle to stop (most of) the automations that run when
      no-one is at home from triggering
  - Requires "Everyone away"-state template binary sensor (see above)
  - Perhaps this should also disable some of the "stricter" alarm triggers
    (vibration and motion during "Armed night"; maybe even the `openclose`
    sensors)?
- [ ] Keep an eye on
      <https://dresden-elektronik.github.io/deconz-rest-doc/endpoints/alarmsystems/>
- [ ] Create a "Auto-disarm for Housekeeper" toggle (similar to the "Auto-arm at
      night" toggle) that controls whether the alarm is automatically disabled
      next time the housekeeper comes by

## Arlo

- [ ] Arlo snapshots used in notifications should be stored locally. The URL
      provided by Arlo always represents the _latest_ snapshot, not the specific
      snapshot at the point in time the URL was retrieved... This is problematic
      for notifications in Lovelace as they will (after a while) start showing
      the wrong image (i.e. the image is loaded when the notification is viewed,
      not ‚Äì as on Android ‚Äì when the notification is raised)
- [ ] Organise the Arlo captures in yearly folders
- [ ] üöÄ Way out there: Use a machine-learned model to classify the camera
      snapshots and act on them only if there's something out of the ordinary
      going on...

## Network

- [ ] DD-WRT-1 appears to forget its Virtual AP settings on reboot...
- [ ] Test (i.e. keep an eye on) whether the ping-scripts on DD-WRT-1 and
      DD-WRT-2 automatically start on a reboot of the device
- [ ] Upgrade both DD-WRT units to the latest firmware version
- [ ] Setup a "devices" VLAN and a separate "devices" WiFi and setup switches
      and routing in such a way that only Home Assistant's Raspberry Pi can talk
      to both the _regular_ and the "devices" network
  - Move all untrusted/"IoT"-type devices to the "devices" network/WiFi
  - Limit/prevent Internet access for all Qingping and Broadlink devices. It
    should be easy to toggle this on and off on demand as occasionally Internet
    connectivity _is_ required to setup/configure these devices
- [ ] The SSH-key and OpenVPN-certificate used on my phone have the wrong Common
      Name (namely, that of one of my previous phones)

## Hardware

- [ ] The Heiman Zigbee alarm-"sensor" in the Wardrobe drops off the
      Zigbee-network every half hour (comes back after a couple minutes). When
      it does this, it takes the Xiaomi Zigbee smart-plug (connected to the
      Airco) in the Bedroom with it... Verify the problem is caused by the
      alarm-sensor, if so, buy a new one / find an alternative solution
- [ ] The Xiaomi two-gang Zigbee relay in the Attic hallway sometimes refuses to
      switch off one of its gangs (always the same). The Zigbee network thinks
      the light is off (it's actually still on); turning it off again properly
      turns off the light.
- [ ] Both the Qingping and Broadlink devices need Internet-connectivity to be
      set up . Once they're up and running they are managed fully locally ‚Äì no
      need for Internet-connectivity. Block their MAC addresses in the router to
      prevent them from "phoning home" (actually, more to prevent people from
      "phoning in" through them).
- [ ] The Bluetooth-stack on the Pi0 in the Bedroom appears to crash roughly
      (but reliably) 24 hours after reboot. Restarting it manually (and
      subsequently restarting the `bt2mqtt`-container) makes it run reliably
      till the next boot...
  - Investigate? Perhaps don't bother and simply restart the entire stack every
    24 hours or so?
- [ ] Replace the upstairs Hallway and Guestroom bulbs with Hue filament bulbs
      (and remove the Zigbee-units from the power-sockets)
