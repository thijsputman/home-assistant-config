hue_activate_scene:
  alias: Hue activate scene
  description: >-
    Activate a Hue scene based on the scene heuristically detected and stored in
    one of the Hue scene template sensors.
  icon: mdi:movie-open-star
  fields:
    scene_entity:
      description: Hue scene template sensor
      required: true
      selector:
        entity:
          include_entities:
            - sensor.hue_scene_living_room
            - sensor.hue_scene_kitchen
            - sensor.hue_scene_kitchen_counter_cupboards
            - sensor.hue_scene_garden
  sequence:
    - if:
        - >-
          {{
            state_attr(scene_entity, 'scene_id') is defined and
            state_attr(scene_entity, 'scene_id') != '<None>'
          }}
      then:
        - service: scene.turn_on
          target:
            entity_id: >-
              {{ state_attr(scene_entity, 'scene_id') }}
      else:
        - if:
            - >-
              {{ states(scene_entity) == '<Off>' }}
          then:
            - service: light.turn_off
              target:
                entity_id: >-
                  {{ state_attr(scene_entity, 'light_id') }}
  mode: parallel
  max: 5
hue_activate_scene_kitchen:
  alias: Hue activate scene (Kitchen)
  description: >-
    Retain the "Activity" scene in Kitchen counter & cupboards while
    transitioning the Kitchen as a whole to another scene. Can also turn off
    the lights in the Kitchen (leave "scene_id" empty for this).
  icon: mdi:movie-open-star
  fields:
    scene_id:
      description: Scene entity for the Kitchen
      selector:
        entity:
          filter:
            - domain: scene
    turn_off:
      description: Turn off the Kitchen lights
      selector:
        boolean: # yamllint disable-line rule:empty-values
  sequence:
    - if:
        - >-
          {{ scene_id is defined and scene_id is match('^scene\.kitchen_.+') }}
      then:
        # Only relevant if Kitchen counter & cupboards is in "Activity"
        - if:
            - condition: state
              entity_id: sensor.hue_scene_kitchen_counter_cupboards
              state: Activity
          then:
            - service: scene.turn_on
              target:
                entity_id: >-
                  {{ scene_id }}
            # Wait for the Kitchen to register its change before changing
            # counter & cupboards; this is required for the scene heuristic to
            # work properly. Not doing so will lead the Kitchen to revert back
            # to its previous scene (instead of the newly activated one) after
            # "Activity" in counter & cupboards ends.
            - wait_for_trigger:
                - platform: template
                  value_template: >-
                    {{
                      state_attr('sensor.hue_scene_kitchen', 'scene_id') ==
                        scene_id
                    }}
              timeout: "00:00:10"
              continue_on_timeout: false
            - service: scene.turn_on
              target:
                entity_id: scene.kitchen_counter_cupboards_activity
          # Otherwise, simply apply the scene to Kitchen alone
          else:
            - service: scene.turn_on
              target:
                entity_id: >-
                  {{ scene_id }}
      # Identical â€” for turning off the lights...
      else:
        - if:
            - >-
              {{ turn_off is true }}
          then:
            - if:
                - condition: state
                  entity_id: sensor.hue_scene_kitchen_counter_cupboards
                  state: Activity
              then:
                - service: light.turn_off
                  target:
                    entity_id: light.kitchen
                - wait_for_trigger:
                    - platform: state
                      entity_id: sensor.hue_scene_kitchen
                      to: <Off>
                  timeout: "00:00:10"
                  continue_on_timeout: false
                - service: scene.turn_on
                  target:
                    entity_id: scene.kitchen_counter_cupboards_activity
              else:
                - service: light.turn_off
                  target:
                    entity_id: light.kitchen
          # Provide some feedback in case of invalid/missing arguments
          else:
            - service: system_log.write
              data:
                level: error
                message: >-
                  Invalid call to script.hue_activate_scene_kitchen: incorrect
                  "scene_id" or missing "turn_off"
  mode: parallel
  max: 5
